#!/bin/bash

if [ -e "$PWD/before_docker.sh" ]; then
    source "$PWD/before_docker.sh"
fi

SCRIPT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

{{#if docker_file }}
docker build ^
--tag {{ container }} \
--file {{ docker_file }} \
"$SCRIPT_ROOT"
{{/if}}
{{#each create_volumes}}
docker volume create {{@key}} > /dev/null 2>&1
{{/each}}
docker run --rm $EXTRA_DOCKER_COMMANDS \
--interactive \
--tty \
{{#each volumes}}
-v {{@key}}:{{this}} \
{{/each}}
{{#if working_directory}}
-w {{working_directory}} \
{{/if}}
{{#each ports}}
-p {{@key}}:{{this}} \
{{/each}}
{{#each extra_parameters}}
{{{this}}} \
{{/each}}
{{ container }} {{{ command }}} $@

LAST_ERROR=$?

if [ -e "$PWD/after_docker.sh" ]; then
    source "$PWD/after_docker.sh"
fi

exit $LAST_ERROR
